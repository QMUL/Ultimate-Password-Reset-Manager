
// Perform some basic validation on the password and usernames

$( document ).ready(function() {
  
  // The state of the system
  var is_valid = {};
  is_valid["username"] = false;
  is_valid["passwords"] = false;
  is_valid["cracklib"] = false;
  is_valid["otporpass"] = false;

  var p1_visited = false;
  var p2_visited = false;


  // is the username valid but dont blank
  function is_username_valid() {
    is_valid["username"] =  $('#user').val().length != 0;
  }

  function are_passwords_valid() {
   
    var p1 = $('#p1').val();
    var p2 = $('#p2').val();
    if (!(p1 == p2) || (p1.length < 8) || (p2.length < 9) ){
      is_valid["passwords"] = false;
    } else {
      is_valid["passwords"] = true;
    }
  }

  // Remove all error warnings
  function all_warnings_off () {
    warning_username (false);
    warning_password (false);
    warning_cracklib (false);
  }

  // Make sure username isnt blank
  function warning_username (on) {
    if (on){
      if (!($('#user').parent().is('div'))){
        $('#user').wrap("<div class=\"alert alert-danger\"  role=\"alert\">");
        $('#user').before("<div id=\"user_warning_msg\">Username cannot be blank.</div>");
      }
    } 

    if ($('#user').parent().is('div')){
      $('#user').unwrap();
      $('#user_warning_msg').remove();
    }    

  }
 
  // If the user starts typing in one box, grey one out
  
  function grey_out_username_otp() {
    var p0 = $('#p0');
    var otp = $('#otp');
    
    if (p0.val().length > 0){
      otp.attr('readonly', true);
      p0.attr('readonly', false);
    } else if (otp.val().length > 0){
      otp.attr('readonly', false);
      p0.attr('readonly', true);
    }
    if (otp.val().length == 0 && p0.val().length == 0) {
      otp.attr('readonly', false);
      p0.attr('readonly', false);
 
    }
    
  } 


  // Warning generated by cracklib - related to password strength basically
  function warning_cracklib(on,msg) {
    if (on){
      if (p1_visited) {
        if ($('#password_strength_msg').length == 0){
          $('#p1').wrap("<div class=\"alert alert-danger\"  role=\"alert\">");
          $('#p1').before("<div id=\"password_strength_msg\">" + msg + "</div>"); 
        } else {
          $("#password_strength_msg").replaceWith("<div id=\"password_strength_msg\">" + msg + "</div>");
        }
      }
    } else {
      if ($('#password_strength_msg').length == 1){   
        $('#p1').unwrap();
        $('#password_strength_msg').remove();
      }
    }
  }


  // Make sure both passwords match and are not 0 
  function warning_password(on) {
    if (on) {
      if (!($('#new_password_fields').parent().is('div'))){
        $('#new_password_fields').wrap("<div class=\"alert alert-danger\"  role=\"alert\">");
        $('#new_password_fields').before("<div id=\"password_warning_msg\">New passwords must match and be 9 characters or more.</div>");
	    }
            
    } else { 

      if ($('#new_password_fields').parent().is('div')){
        $('#new_password_fields').unwrap();
        $('#password_warning_msg').remove();
      }
    }
  }

 
  // If isvalid is false, stop the user from continuing to the next page
  function grey_out_button() {
    if (is_form_valid()){
      $("#main_form_submit").removeAttr("disabled");      
    } else { 
      $("#main_form_submit").attr("disabled","disabled");     
    }
  }

  // Validators and event listeners
 
  function is_form_valid() {
    for (var key in is_valid){
      if(!is_valid[key]){
        return false;
      }
    }
    return true;
  }
  
  // Async call for grey out button based on cracklib check
  function password_strength(){
    is_valid['cracklib'] = false;

    $.post("/check", {password : $("#p1").val()}).done( function(data) {
      if (data.search("GOOD") == -1){
        is_valid['cracklib'] = false;
        warning_cracklib(true,data); 
      } else {
        is_valid['cracklib'] = true;
        warning_cracklib(false,"");
      }
      grey_out_button();
    });
  }
  
  // Internal function called to check everything and set state
  function _password_stuff() {

    if($('#p2').val().length == 0 &&  $('#p1').val().length == 0){
      all_warnings_off()
      p1_visited = false;
      p2_visited = false;
      return
    }

    are_passwords_valid();
    is_username_valid();
    if (p1_visited && p2_visited){
      warning_password(!is_valid["passwords"]);
    }
    
    grey_out_button();
  }

  // Pass OTP Check
  
  function _otpOrPass() {
    if ($('#p0').val().length == 0 && $('#otp').val().length == 0) {
      is_valid["otporpass"] = false;
    } else {
      is_valid["otporpass"] = true;
    }
  }

  // Actions to be watched out for on the form
  $('#p1').on('focusout', function() {
    p1_visited = true; 
    password_strength();
    _password_stuff();
  });

  $('#p2').on('focusout', function() {
    p2_visited = true;
    _password_stuff();
  });

  $('#p2').on('keyup', function() {
    if($('#p2').val().length >= $('#p1').val().length){ 
      _password_stuff(); 
    }
  });
 
  $('#p1').on('keyup', function() {
    if($('#p2').val().length >= $('#p1').val().length){ 
      _password_stuff(); 
    }
  });
 
  $('#user').on('focusout', function() {
    is_username_valid();
    warning_username(!is_valid["username"]);
    grey_out_button();
  });

  $('#otp').on('keyup', function() { _otpOrPass(); grey_out_button(); } ); 
  $('#p0').on('keyup', function() { _otpOrPass(); grey_out_button(); } ); 

  /*$('#main_form').on('submit', function() {
     return validate_form();
  });*/

  /*$('#p0').keyup( function() { grey_out_username_otp(); grey_out_button() }  );
  $('#otp').keyup( function() { grey_out_username_otp(); grey_out_button() } );*/
 
  $('#p0').on('focusout', function() { _otpOrPass(); grey_out_username_otp(); });
  $('#otp').on('focusout',function() { _otpOrPass(); grey_out_username_otp(); });


  // Duplicating a lot here. Needs improvement
  $('#p0').on('input', function() { _otpOrPass(); grey_out_username_otp(); }); 
  $('#otp').on('input', function() { _otpOrPass(); grey_out_username_otp(); });

  $('#p1').on('input', function() {
    p1_visited = true;  
    grey_out_button();
  });

  $('#p2').on('input', function() {
    p2_visited = true;
    grey_out_button();
  });

  $('#p2').on('input', function() {
    if($('#p2').val().length >= $('#p1').val().length){ 
      _password_stuff(); 
    }
  });
 
  $('#p1').on('input', function() {
    if($('#p2').val().length >= $('#p1').val().length){ 
      _password_stuff(); 
    }
  });
 
  $('#user').on('input', function() {
    is_username_valid();
    warning_username(!is_valid["username"]);
    grey_out_button();
  });



});
